// M-Control — AI Growth OS — Account-Based SaaS
// Tenant = platform scope. Account = isolation unit (per-company). All business data has account_id.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ——— Platform & Account ———
model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts       Account[]
  users          User[]
  roles          Role[]
  clients        Client[]
  auditLogs      AuditLog[]
}

model Account {
  id           String    @id @default(cuid())
  tenantId     String
  name         String
  industry     String?
  timezone     String?    @default("UTC")
  logo         String?
  primaryColor String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles    UserAccountRole[]
  clients      Client[]
  integrations Integration[]
  metrics      Metric[]
  alerts       Alert[]
  savedSearches SavedSearch[]
  reports      Report[]
  seoKeywords  SeoKeyword[]
  leads        Lead[]
  articles     Article[]
  automations  Automation[]
  auditLogs    AuditLog[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

// User ↔ Account pivot with per-account role
model UserAccountRole {
  id        String   @id @default(cuid())
  userId    String
  accountId String
  role      String   // Owner, Admin, Editor, Viewer
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([userId, accountId])
  @@index([userId])
  @@index([accountId])
}

model Client {
  id        String   @id @default(cuid())
  tenantId  String
  accountId String
  name      String
  slug      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  metrics Metric[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([accountId])
}

// ——— Auth (user is platform-level; access to accounts via UserAccountRole) ———
model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  name         String?
  roleId       String?  // legacy / tenant-level; per-account role is UserAccountRole.role
  isSuperAdmin Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role      Role?             @relation(fields: [roleId], references: [id], onDelete: SetNull)
  accountRoles UserAccountRole[]
  savedSearches SavedSearch[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  permissions String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  User[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ——— Audit (account-scoped) ———
model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  accountId  String?
  userId     String?
  action     String
  resource   String?
  resourceId String?
  details    Json?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([accountId])
  @@index([tenantId, createdAt])
}

// ——— Integrations (per-account; external property mapping) ———
model Integration {
  id                    String    @id @default(cuid())
  accountId             String
  provider               String    // google_analytics, gsc, google_ads, meta_ads, linkedin_ads
  externalPropertyId    String?
  name                  String?
  encryptedAccessToken  String?
  encryptedRefreshToken String?
  tokenExpiry           DateTime?
  metadataJson          Json?
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, provider])
}

// ——— Business data (all account-scoped) ———
model Metric {
  id              String   @id @default(cuid())
  accountId       String
  clientId        String?
  metricType      String
  value           Decimal  @db.Decimal(18, 4)
  date            DateTime @db.Date
  source          String?
  relatedEntityId String?
  createdAt       DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  client  Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, clientId])
  @@index([accountId, metricType, date])
  @@index([accountId, date])
}

model Alert {
  id        String   @id @default(cuid())
  accountId String
  clientId  String?
  type      String
  title     String
  message   String?
  severity  String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, createdAt])
}

model SavedSearch {
  id        String   @id @default(cuid())
  accountId String
  userId    String
  name      String
  query     String
  filters   Json?
  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, userId])
}

model Report {
  id          String    @id @default(cuid())
  accountId   String
  clientId    String?
  name        String
  description String?
  metricTypes String[]
  dateRange   String    @default("30d")
  dateFrom    DateTime?
  dateTo      DateTime?
  breakdown   String    @default("daily")
  source      String?
  shareToken  String?   @unique
  shareExpiry DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([shareToken])
}

model SeoKeyword {
  id          String   @id @default(cuid())
  accountId   String
  clientId    String?
  keyword     String
  impressions Int      @default(0)
  clicks      Int      @default(0)
  position    Decimal  @db.Decimal(5, 2)
  date        DateTime @db.Date
  createdAt   DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, clientId, date])
}

model Lead {
  id        String   @id @default(cuid())
  accountId String
  clientId  String?
  email     String
  name      String?
  source    String?
  status    String   @default("new")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, clientId])
  @@index([accountId, status])
}

model Article {
  id        String   @id @default(cuid())
  accountId String
  clientId  String?
  title     String
  body      String?  @db.Text
  status    String   @default("draft")
  aiPrompt  String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, clientId])
}

model Automation {
  id            String   @id @default(cuid())
  accountId     String
  name          String
  trigger       String
  triggerConfig Json?
  action        String
  actionConfig  Json?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}
